<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Photo EXIF Data Reader</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        #preview {
            max-width: 100%;
            max-height: 300px;
        }

        #dropArea {
            border: 2px dashed #aaa;
            padding: 20px;
            text-align: center;
        }

        .form-group {
            margin-top: 15px;
        }

    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mt-3">Photo EXIF Data Reader</h1>
        <div class="row justify-content-center mt-4">
            <div class="col-12 col-md-6">
                <div id="dropArea" ondragover="allowDrop(event)" ondrop="handleDrop(event)">
                    <p>Drag and drop a photo here</p>
                    <p>or</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;"
                        onchange="readExifData(this)">
                    <label for="fileInput" class="btn btn-primary">Select Photo</label>
                </div>
                <img id="preview" src="" alt="Preview" style="display: none;">
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 col-md-6">
                <div class="form-group">
                    <label for="latitude">Latitude (Decimal):</label>
                    <input type="text" id="latitude" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude (Decimal):</label>
                    <input type="text" id="longitude" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="modifiedDate">Date:</label>
                    <input type="text" id="modifiedDate" class="form-control" readonly>
                    
                    <input type="hidden" id="modifiedDateDefault">
                </div>
                <div class="form-group">
                    <label for="author">Author:</label>
                    <input type="text" id="author" class="form-control">
                </div>
                <div class="form-group">
                    <label for="title">Title (English):</label>
                    <small class="form-text text-muted">
                        Format: Location name - City - Country (e.g., "Sagrada Familia - Barcelona - Spain")
                    </small>
                    <input type="text" id="title" class="form-control" oninput="searchSimilarMarkers()">
                </div>
                <div class="form-group">
                    <label for="titlePL">Title (Polish):</label>
                    <small class="form-text text-muted">
                        Format: Nazwa miejsca - Miasto - Kraj (np. "Sagrada Familia - Barcelona - Hiszpania")
                    </small>
                    <input type="text" id="titlePL" class="form-control" oninput="searchSimilarMarkers()">
                </div>
                <div id="similarMarkers" class="alert alert-info" style="display: none;">
                    <strong>Similar locations found:</strong>
                    <ul id="similarMarkersList" style="margin-bottom: 0;"></ul>
                </div>
                <div class="form-group">
                    <label for="comment">Comment (English):</label>
                    <input type="text" id="comment" class="form-control">
                </div>
                <div class="form-group">
                    <label for="commentPL">Comment (Polish):</label>
                    <input type="text" id="commentPL" class="form-control">
                </div>
                <div class="form-group">
                    <label>Type:</label>
                    <div class="form-check">
                        <input type="radio" name="type" id="typeCan" value="Can" class="form-check-input">
                        <label for="typeCan" class="form-check-label">Can</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" name="type" id="typeBottle" value="Bottle" class="form-check-input">
                        <label for="typeBottle" class="form-check-label">Bottle</label>
                    </div>
                </div>
                <button onclick="generateJSON()" class="btn btn-success mt-3">Generate JSON</button>
                <div class="form-group">
                    <label for="jsonOutput">Generated JSON:</label>
                    <textarea id="jsonOutput" class="form-control" rows="4" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="../markers.js"></script>

    <script>
        // Global markers variable will be loaded from markers.js
        let loadedMarkers = [];

        // Wait for markers.js to load
        window.addEventListener('load', function() {
            if (typeof markers !== 'undefined') {
                loadedMarkers = markers;
                console.log('Loaded ' + loadedMarkers.length + ' markers for searching');
            }
        });

        function searchSimilarMarkers() {
            const titleInput = document.getElementById('title').value.toLowerCase();
            const titlePLInput = document.getElementById('titlePL').value.toLowerCase();
            const searchTerms = [titleInput, titlePLInput].filter(term => term.length > 2);

            if (searchTerms.length === 0) {
                document.getElementById('similarMarkers').style.display = 'none';
                return;
            }

            const similarMarkers = [];
            const searchWords = searchTerms.flatMap(term => term.split(/[-\s,]+/).filter(word => word.length > 2));

            loadedMarkers.forEach(marker => {
                const markerTitle = (marker.title || '').toLowerCase();
                const markerTitlePL = (marker.titlePL || '').toLowerCase();

                // Check if any search word matches in titles
                const hasMatch = searchWords.some(word =>
                    markerTitle.includes(word) || markerTitlePL.includes(word)
                );

                if (hasMatch) {
                    // Calculate relevance score (how many words match)
                    const score = searchWords.reduce((acc, word) => {
                        return acc + (markerTitle.includes(word) ? 1 : 0) + (markerTitlePL.includes(word) ? 1 : 0);
                    }, 0);

                    similarMarkers.push({
                        title: marker.title,
                        titlePL: marker.titlePL,
                        author: marker.author,
                        score: score
                    });
                }
            });

            // Sort by relevance (higher score first)
            similarMarkers.sort((a, b) => b.score - a.score);

            // Display results
            const markersList = document.getElementById('similarMarkersList');
            const markersDiv = document.getElementById('similarMarkers');

            if (similarMarkers.length > 0) {
                markersList.innerHTML = similarMarkers.slice(0, 10).map(marker =>
                    `<li><strong>EN:</strong> ${marker.title || 'N/A'}<br><strong>PL:</strong> ${marker.titlePL || 'N/A'}<br><small class="text-muted">Author: ${marker.author}</small></li>`
                ).join('');
                markersDiv.style.display = 'block';
            } else {
                markersDiv.style.display = 'none';
            }
        }
    </script>

    <script>
        function allowDrop(event) {
            event.preventDefault();
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            document.getElementById('fileInput').files = event.dataTransfer.files;
            readExifData(document.getElementById('fileInput'));
        }

        function readExifData(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function () {
                        EXIF.getData(this, function () {
                            const lat = EXIF.getTag(this, 'GPSLatitude');
                            const lon = EXIF.getTag(this, 'GPSLongitude');
                            const modifiedDate = new Date(file.lastModified);

                            document.getElementById('latitude').value = lat ? getDecimalFromDMS(lat, EXIF.getTag(this, 'GPSLatitudeRef')) : '';
                            document.getElementById('longitude').value = lon ? getDecimalFromDMS(lon, EXIF.getTag(this, 'GPSLongitudeRef')) : '';
                            document.getElementById('modifiedDate').value = modifiedDate ? modifiedDate.toLocaleString() : '';
                            document.getElementById('modifiedDateDefault').value = modifiedDate ? modifiedDate : '';

                            document.getElementById('preview').src = e.target.result;
                            document.getElementById('preview').style.display = 'block';
                        });
                    };
                };

                reader.readAsDataURL(file);
            }
        }

        function getDecimalFromDMS(dms, ref) {
            const [degrees, minutes, seconds] = dms;
            const decimal = degrees + minutes / 60 + seconds / 3600;

            if (ref === 'S' || ref === 'W') {
                return -decimal;
            } else {
                return decimal;
            }
        }

        function generateJSON() {
            const latitude = parseFloat(document.getElementById('latitude').value) || 0;
            const longitude = parseFloat(document.getElementById('longitude').value) || 0;
            const photoInput = document.getElementById('fileInput');
            const photo = photoInput ? photoInput.value : '';
            const authorInput = document.getElementById('author');
            const author = authorInput ? authorInput.value : '';
            const titleInput = document.getElementById('title');
            const title = titleInput ? titleInput.value : '';
            const titlePLInput = document.getElementById('titlePL');
            const titlePL = titlePLInput ? titlePLInput.value : '';
            const commentInput = document.getElementById('comment');
            const comment = commentInput ? commentInput.value : '';
            const commentPLInput = document.getElementById('commentPL');
            const commentPL = commentPLInput ? commentPLInput.value : '';
            const typeInput = document.querySelector('input[name="type"]:checked');
            const type = typeInput ? typeInput.value.toLowerCase() : '';

            const photoPath = `photos/${author.toLowerCase()}/${photo.replace("C:\\fakepath\\", "")}`;


            const dateValueInput = document.getElementById('modifiedDateDefault');
            const dateValue = dateValueInput ? new Date(dateValueInput.value).toISOString(): '';


            const json = {
                latitude,
                longitude,
                photo: photoPath,
                author,
                title,
                ...(titlePL && { titlePL }),
                type,
                ...(comment && { comment }),
                ...(commentPL && { commentPL }),
                ...(dateValue && { datetime: dateValue })
            };

            const jsonOutput = JSON.stringify(json, null, 2);
            document.getElementById('jsonOutput').value = jsonOutput.replace(/"([^"]+)":/g, '$1:');
        }

    </script>
</body>

</html>